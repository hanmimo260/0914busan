<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶•ì œ ë¶€ìŠ¤ ì‹ ì²­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FCE4EC; /* ì—°ë¶„í™ ë°°ê²½ìƒ‰ */
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.5);
        }
        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: white;
            transition: all 0.2s ease-in-out;
        }
        .submit-btn:hover {
            opacity: 0.85;
        }
        .booth-card {
            background-color: #e0e7ff;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #c7d2fe;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        h1 {
            color: #E91E63; /* ì§„ë¶„í™ íƒ€ì´í‹€ ìƒ‰ìƒ */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6">
            ì¶•ì œ ë¶€ìŠ¤ ì‹ ì²­
        </h1>
        <p class="text-center text-sm text-gray-500 mb-8">
            ì„ ìƒë‹˜ë“¤ì´ ìš´ì˜í•˜ì‹¤ ë¶€ìŠ¤ ì •ë³´ì™€ í•„ìš”í•œ ë¬¼í’ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
        </p>
        
        <!-- í˜„ì¬ ì‚¬ìš©ì ID í‘œì‹œ -->
        <div class="mb-6 bg-gray-100 p-4 rounded-xl text-sm break-words">
            <span class="font-bold">í˜„ì¬ ì‚¬ìš©ì ID:</span> <span id="userIdDisplay">ë¡œë”© ì¤‘...</span>
        </div>
        
        <!-- Gemini API ê¸°ëŠ¥: ë¶€ìŠ¤ ì•„ì´ë””ì–´ ìƒì„± -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                âœ¨ ì•„ì´ë””ì–´ ì–»ê¸°
            </h2>
            <p class="text-sm text-gray-500 mb-4">
                ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ Gemini AIê°€ ì¶•ì œ ë¶€ìŠ¤ ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•˜ì—¬ ìë™ìœ¼ë¡œ ì…ë ¥í•´ì¤ë‹ˆë‹¤.
            </p>
            <button id="generateIdeaBtn" class="submit-btn bg-pink-500 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9.043 18l-1.63-1.63M12 21l-3.375-3.375M19.986 4.647L21 9l-1.014 4.353m-10.45 3.54L9 14.54l-1.63-1.63M14.54 9.043L18 9l-3.46-3.46m-6.42 13.56L9 19.986l-4.353-1.014m13.56-6.42l-1.63 1.63M5 14.54l1.63-1.63M12 3v18M3 12h18" />
                </svg>
                AIê°€ ë¶€ìŠ¤ ì•„ì´ë””ì–´ ìƒì„±í•˜ê¸°
            </button>
            <div id="loadingMessage" class="hidden text-center text-sm text-gray-500 mt-2">
                ì•„ì´ë””ì–´ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...
            </div>
        </div>
        
        <!-- ì¿ íŒ¡ ê²€ìƒ‰ ê¸°ëŠ¥ -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                ğŸ›ï¸ ë¬¼í’ˆ ê°€ê²© ê²€ìƒ‰
            </h2>
            <p class="text-sm text-gray-500 mb-4">
                í•„ìš”í•œ ë¬¼í’ˆëª…ì„ ì…ë ¥í•˜ê³  ì¿ íŒ¡ì—ì„œ ê°€ê²©ì„ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.
            </p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="coupangSearchInput" class="form-input flex-grow" placeholder="ê²€ìƒ‰í•  ë¬¼í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í’ì„ )">
                <button id="coupangSearchBtn" class="submit-btn bg-pink-500 sm:w-auto flex-shrink-0">
                    ì¿ íŒ¡ì—ì„œ ê²€ìƒ‰í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ì‹ ì²­ í¼ -->
        <form id="boothForm" class="flex flex-col gap-4">
            <div>
                <label for="boothName" class="block text-gray-700 font-semibold mb-2">ë¶€ìŠ¤ëª…</label>
                <input type="text" id="boothName" name="boothName" class="form-input" placeholder="ì˜ˆ: VR ì²´í—˜, ê³¼í•™ ë§ˆìˆ ì‡¼" required>
            </div>
            <div>
                <label for="teacherName" class="block text-gray-700 font-semibold mb-2">ì„ ìƒë‹˜ ì´ë¦„</label>
                <input type="text" id="teacherName" name="teacherName" class="form-input" placeholder="ì˜ˆ: ê¹€ë¯¼ì§€ ì„ ìƒë‹˜" required>
            </div>
            <div>
                <label for="boothDescription" class="block text-gray-700 font-semibold mb-2">ë¶€ìŠ¤ ì„¤ëª…</label>
                <textarea id="boothDescription" name="boothDescription" rows="4" class="form-input" placeholder="ì˜ˆ: VR ê¸°ê¸°ë¥¼ í™œìš©í•˜ì—¬ ìš°ì£¼ë¥¼ íƒí—˜í•˜ëŠ” ì²´í—˜ì…ë‹ˆë‹¤. ì°¸ê°€ í•™ìƒì€ ì§ì ‘ ê°€ìƒì˜ ìš°ì£¼ì„ ì„ ì¡°ì¢…í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤." required></textarea>
            </div>
            
            <!-- ë¬¼í’ˆ ë° ê°€ê²© ì…ë ¥ ì„¹ì…˜ -->
            <div id="itemsSection">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">í•„ìš” ë¬¼í’ˆ ë° ê°€ê²©</h3>
                <div id="itemsList" class="mb-2">
                    <!-- ë¬¼í’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="itemNameInput" class="form-input flex-grow" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: í’ì„ )">
                    <input type="number" id="itemPriceInput" class="form-input w-28" placeholder="ê°€ê²© (ì›)">
                    <button type="button" id="addItemBtn" class="submit-btn bg-pink-500 w-auto flex-shrink-0">
                        ì¶”ê°€
                    </button>
                </div>
            </div>

            <button type="submit" class="submit-btn bg-pink-500">
                ì •ë³´ ì œì¶œí•˜ê¸°
            </button>
        </form>

        <hr class="my-8 border-gray-300">

        <!-- ë¶€ìŠ¤ ëª©ë¡ í‘œì‹œ ì˜ì—­ -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
            ì œì¶œëœ ë¶€ìŠ¤ ëª©ë¡
        </h2>
        <div id="boothList" class="flex flex-col gap-4">
            <!-- ë¶€ìŠ¤ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            <p class="text-center text-gray-500">
                ì•„ì§ ì œì¶œëœ ë¶€ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.
            </p>
        </div>

        <hr class="my-8 border-gray-300">

        <!-- ì„ ìƒë‹˜ë³„ ì´ ì§€ì¶œ ê¸ˆì•¡ ìš”ì•½ -->
        <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                ì„ ìƒë‹˜ë³„ ì´ ì§€ì¶œ ê¸ˆì•¡ ìš”ì•½
            </h2>
            <div id="teacherTotals" class="space-y-2">
                <!-- ì„ ìƒë‹˜ë³„ ì´ì•¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

    </div>

    <!-- Firebase SDK ë° Gemini API ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // Firebase SDK ëª¨ë“ˆì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë° ì¸ì¦ ê°ì²´ ì„ ì–¸
        let db;
        let auth;
        let userId;

        // Firestore ì „ì—­ ë³€ìˆ˜ ì„¤ì • (ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ì œê³µ)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // HTML ìš”ì†Œ ì°¸ì¡°
        const boothForm = document.getElementById('boothForm');
        const boothNameInput = document.getElementById('boothName');
        const teacherNameInput = document.getElementById('teacherName');
        const boothDescriptionTextarea = document.getElementById('boothDescription');
        const itemsListElement = document.getElementById('itemsList');
        const itemNameInput = document.getElementById('itemNameInput');
        const itemPriceInput = document.getElementById('itemPriceInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const boothList = document.getElementById('boothList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const generateIdeaBtn = document.getElementById('generateIdeaBtn');
        const loadingMessage = document.getElementById('loadingMessage');
        const coupangSearchInput = document.getElementById('coupangSearchInput');
        const coupangSearchBtn = document.getElementById('coupangSearchBtn');
        const teacherTotalsElement = document.getElementById('teacherTotals');
        const apiKey = ""; // API key for Gemini API

        // ì„ì‹œ ë¬¼í’ˆ ëª©ë¡ ë°°ì—´
        let currentItems = [];

        // Firebase ì´ˆê¸°í™” í•¨ìˆ˜
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ì‚¬ìš©ì ì¸ì¦
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // ì‚¬ìš©ì IDê°€ í™•ì¸ëœ í›„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                        startRealtimeListener();
                    } else {
                        userId = 'guest'; // ì„ì‹œ ì‚¬ìš©ì ID
                        userIdDisplay.textContent = 'ìµëª… ì‚¬ìš©ì';
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                userIdDisplay.textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        };

        // ë°ì´í„°ë² ì´ìŠ¤ì— ë¶€ìŠ¤ ì •ë³´ ì¶”ê°€
        const addBooth = async (boothData) => {
            try {
                const boothsCollectionRef = collection(db, `artifacts/${appId}/public/data/booths`);
                await addDoc(boothsCollectionRef, boothData);
            } catch (error) {
                console.error("ë¶€ìŠ¤ ì •ë³´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        };
        
        // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¶€ìŠ¤ ì •ë³´ ì‚­ì œ
        const deleteBooth = async (docId) => {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/booths`, docId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("ë¶€ìŠ¤ ì •ë³´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        };

        // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¶€ìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸
        const updateBooth = async (docId, newData) => {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/booths`, docId);
                await updateDoc(docRef, newData);
            } catch (error) {
                console.error("ë¶€ìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        };

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
        const startRealtimeListener = () => {
            const boothsCollectionRef = collection(db, `artifacts/${appId}/public/data/booths`);
            const q = query(boothsCollectionRef);

            // onSnapshotì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„° ë³€ê²½ì„ ê°ì§€í•˜ê³  UI ì—…ë°ì´íŠ¸
            onSnapshot(q, (snapshot) => {
                boothList.innerHTML = '';
                const teacherTotals = {};
                
                if (snapshot.empty) {
                    boothList.innerHTML = `
                        <p class="text-center text-gray-500 p-4">
                            ì•„ì§ ì œì¶œëœ ë¶€ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </p>
                    `;
                    teacherTotalsElement.innerHTML = `
                        <p class="text-center text-gray-500">
                            ìš”ì•½í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </p>
                    `;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    
                    // ê° ë¶€ìŠ¤ì˜ ë¬¼í’ˆ ì´ ê°€ê²© ê³„ì‚°
                    const totalItemsPrice = (Array.isArray(data.items) ? data.items : []).reduce((sum, item) => sum + (item.price || 0), 0);
                    
                    // ì„ ìƒë‹˜ë³„ ì´ ì§€ì¶œ ê¸ˆì•¡ ëˆ„ì 
                    if (data.authorId) {
                        if (!teacherTotals[data.authorId]) {
                            teacherTotals[data.authorId] = {
                                total: 0,
                                teacherName: data.teacherName || 'ì´ë¦„ ì—†ìŒ'
                            };
                        }
                        teacherTotals[data.authorId].total += totalItemsPrice;
                    }

                    const boothItem = document.createElement('div');
                    boothItem.className = 'booth-card';
                    boothItem.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-900 mb-1">${data.boothName}</h3>
                            <p class="text-gray-600 font-semibold mb-1">ë‹´ë‹¹: ${data.teacherName}</p>
                            <p class="text-sm text-gray-500 mb-2">${data.boothDescription}</p>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                ${(Array.isArray(data.items) ? data.items : []).map(item => `<li>${item.name} (${item.price ? item.price.toLocaleString() + 'ì›' : 'ê°€ê²© ë¯¸ì •'})</li>`).join('')}
                            </ul>
                            <p class="mt-2 font-bold text-gray-800">ì´ ë¬¼í’ˆ ê°€ê²©: ${totalItemsPrice.toLocaleString()}ì›</p>
                            <div class="mt-2 text-xs text-gray-400 break-words">ì œì¶œì ID: ${data.authorId}</div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="edit-btn px-3 py-1 bg-pink-400 text-white rounded-md text-sm hover:bg-pink-500 transition-colors" data-id="${docId}">ìˆ˜ì •</button>
                            <button class="delete-btn px-3 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition-colors" data-id="${docId}">ì‚­ì œ</button>
                        </div>
                    `;
                    boothList.appendChild(boothItem);
                });
                
                // ì„ ìƒë‹˜ë³„ ì´ ì§€ì¶œ ê¸ˆì•¡ ìš”ì•½ ì—…ë°ì´íŠ¸
                teacherTotalsElement.innerHTML = '';
                if (Object.keys(teacherTotals).length > 0) {
                    for (const id in teacherTotals) {
                        const total = teacherTotals[id].total;
                        const name = teacherTotals[id].teacherName;
                        const totalItem = document.createElement('div');
                        totalItem.className = 'flex justify-between items-center text-gray-700';
                        totalItem.innerHTML = `
                            <span>${name} (${id.substring(0, 6)}...):</span>
                            <span class="font-bold text-lg">${total.toLocaleString()}ì›</span>
                        `;
                        teacherTotalsElement.appendChild(totalItem);
                    }
                } else {
                    teacherTotalsElement.innerHTML = `
                        <p class="text-center text-gray-500">
                            ìš”ì•½í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </p>
                    `;
                }
            });
        };
        
        // ë¬¼í’ˆ ì¶”ê°€ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        addItemBtn.addEventListener('click', () => {
            const itemName = itemNameInput.value.trim();
            const itemPrice = parseInt(itemPriceInput.value, 10);

            if (itemName === '' || isNaN(itemPrice) || itemPrice < 0) {
                // ê²½ê³ ì°½ ëŒ€ì‹  ëª¨ë‹¬ ì‚¬ìš©
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ì•Œë¦¼</h3>
                        <p class="text-gray-600">ìœ íš¨í•œ ë¬¼í’ˆëª…ê³¼ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <div class="flex justify-end mt-4">
                            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none close-modal">í™•ì¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                return;
            }

            currentItems.push({ name: itemName, price: itemPrice });
            renderItemsList();
            itemNameInput.value = '';
            itemPriceInput.value = '';
            itemNameInput.focus();
        });

        // í˜„ì¬ ë¬¼í’ˆ ëª©ë¡ì„ UIì— ë Œë”ë§
        const renderItemsList = () => {
            itemsListElement.innerHTML = '';
            currentItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg text-sm mb-1';
                itemDiv.innerHTML = `
                    <span>${item.name} (${item.price.toLocaleString()}ì›)</span>
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 transition-colors" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                itemsListElement.appendChild(itemDiv);
            });
        };

        // ë¬¼í’ˆ ì‚­ì œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        itemsListElement.addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-btn')) {
                const index = e.target.closest('.remove-item-btn').dataset.index;
                currentItems.splice(index, 1);
                renderItemsList();
            }
        });

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        boothForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const boothName = boothNameInput.value;
            const teacherName = teacherNameInput.value;
            const boothDescription = boothDescriptionTextarea.value;
            
            if (boothName.trim() === '' || teacherName.trim() === '' || boothDescription.trim() === '' || currentItems.length === 0) {
                // ê²½ê³ ì°½ ëŒ€ì‹  ëª¨ë‹¬ ì‚¬ìš©
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ì•Œë¦¼</h3>
                        <p class="text-gray-600">ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ê³  ë¬¼í’ˆì„ í•˜ë‚˜ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                        <div class="flex justify-end mt-4">
                            <button class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 focus:outline-none close-modal">í™•ì¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                return;
            }

            const boothData = {
                boothName: boothName,
                teacherName: teacherName,
                boothDescription: boothDescription,
                items: currentItems,
                authorId: userId, // í˜„ì¬ ì‚¬ìš©ì IDë¥¼ ë°ì´í„°ì— ì¶”ê°€
                createdAt: new Date()
            };

            await addBooth(boothData);
            boothForm.reset();
            currentItems = []; // ë¬¼í’ˆ ëª©ë¡ ì´ˆê¸°í™”
            renderItemsList();
        });
        
        // ì‚­ì œ/ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
        boothList.addEventListener('click', async (e) => {
            const target = e.target;
            const docId = target.dataset.id;
            
            if (target.classList.contains('delete-btn')) {
                // ì‚­ì œ í™•ì¸ ëª¨ë‹¬
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ì‚­ì œ í™•ì¸</h3>
                        <p class="text-gray-600">ì´ ë¶€ìŠ¤ ì •ë³´ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <div class="flex justify-end mt-4 gap-2">
                            <button type="button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none cancel-modal">ì·¨ì†Œ</button>
                            <button type="button" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none confirm-delete">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('.confirm-delete').addEventListener('click', async () => {
                    await deleteBooth(docId);
                    document.body.removeChild(modal);
                });
                modal.querySelector('.cancel-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            } else if (target.classList.contains('edit-btn')) {
                // ìˆ˜ì • ê¸°ëŠ¥
                const docRef = doc(db, `artifacts/${appId}/public/data/booths`, docId);
                const docSnap = await getDoc(docRef);
                const data = docSnap.data();
                
                let editingItems = data.items || [];
                
                const renderEditItems = () => {
                    let html = '';
                    editingItems.forEach((item, index) => {
                        html += `
                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg text-sm mb-1">
                                <span>${item.name} (${item.price.toLocaleString()}ì›)</span>
                                <button type="button" class="remove-edit-item-btn text-red-500 hover:text-red-700 transition-colors" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        `;
                    });
                    return html;
                };

                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ë¶€ìŠ¤ ì •ë³´ ìˆ˜ì •</h3>
                        <form id="editForm" class="flex flex-col gap-4">
                            <div>
                                <label for="editBoothName" class="block text-gray-700 font-semibold mb-2">ë¶€ìŠ¤ëª…</label>
                                <input type="text" id="editBoothName" name="editBoothName" class="form-input" value="${data.boothName}" required>
                            </div>
                            <div>
                                <label for="editTeacherName" class="block text-gray-700 font-semibold mb-2">ì„ ìƒë‹˜ ì´ë¦„</label>
                                <input type="text" id="editTeacherName" name="editTeacherName" class="form-input" value="${data.teacherName}" required>
                            </div>
                            <div>
                                <label for="editBoothDescription" class="block text-gray-700 font-semibold mb-2">ë¶€ìŠ¤ ì„¤ëª…</label>
                                <textarea id="editBoothDescription" name="editBoothDescription" rows="4" class="form-input" required>${data.boothDescription}</textarea>
                            </div>
                            
                            <div id="editItemsSection">
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">í•„ìš” ë¬¼í’ˆ ë° ê°€ê²©</h3>
                                <div id="editItemsList" class="mb-2">
                                    ${renderEditItems()}
                                </div>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="editItemNameInput" class="form-input flex-grow" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: í’ì„ )">
                                    <input type="number" id="editItemPriceInput" class="form-input w-28" placeholder="ê°€ê²© (ì›)">
                                    <button type="button" id="addEditItemBtn" class="submit-btn bg-pink-500 hover:bg-pink-600 w-auto flex-shrink-0">
                                        ì¶”ê°€
                                    </button>
                                </div>
                            </div>

                            <div class="flex justify-end mt-4 gap-2">
                                <button type="button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none cancel-edit">ì·¨ì†Œ</button>
                                <button type="submit" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 focus:outline-none">ìˆ˜ì • ì™„ë£Œ</button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);

                const editForm = modal.querySelector('#editForm');
                const addEditItemBtn = modal.querySelector('#addEditItemBtn');
                const editItemNameInput = modal.querySelector('#editItemNameInput');
                const editItemPriceInput = modal.querySelector('#editItemPriceInput');
                const editItemsList = modal.querySelector('#editItemsList');

                addEditItemBtn.addEventListener('click', () => {
                    const itemName = editItemNameInput.value.trim();
                    const itemPrice = parseInt(editItemPriceInput.value, 10);
                    if (itemName !== '' && !isNaN(itemPrice) && itemPrice >= 0) {
                        editingItems.push({ name: itemName, price: itemPrice });
                        editItemsList.innerHTML = renderEditItems();
                        editItemNameInput.value = '';
                        editItemPriceInput.value = '';
                    }
                });

                editItemsList.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-edit-item-btn')) {
                        const index = e.target.closest('.remove-edit-item-btn').dataset.index;
                        editingItems.splice(index, 1);
                        editItemsList.innerHTML = renderEditItems();
                    }
                });
                
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newBoothName = modal.querySelector('#editBoothName').value;
                    const newTeacherName = modal.querySelector('#editTeacherName').value;
                    const newBoothDescription = modal.querySelector('#editBoothDescription').value;
                    
                    await updateBooth(docId, { 
                        boothName: newBoothName,
                        teacherName: newTeacherName,
                        boothDescription: newBoothDescription,
                        items: editingItems
                    });
                    document.body.removeChild(modal);
                });
                
                modal.querySelector('.cancel-edit').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }
        });
        
        // Gemini API í˜¸ì¶œ í•¨ìˆ˜
        const generateGeminiIdea = async () => {
            generateIdeaBtn.disabled = true;
            loadingMessage.classList.remove('hidden');

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `You are a creative festival planner. Your task is to generate a single festival booth idea with a catchy name, a brief description, a generic teacher name, and a list of necessary items. Each item must have a name and a price. The final output must be a JSON object with the following structure:
            {
                "boothName": "string",
                "teacherName": "string",
                "boothDescription": "string",
                "items": [
                    {"name": "string", "price": "number"}
                ]
            }.
            Ensure the response is in Korean and the prices are reasonable estimates for festival supplies.`;
            
            const userQuery = "12ì›” ì¶•ì œì— ì í•©í•œ ë¶€ìŠ¤ ì•„ì´ë””ì–´ë¥¼ í•˜ë‚˜ë§Œ ì œì•ˆí•˜ê³ , í•„ìš”í•œ ë¬¼í’ˆê³¼ ê° ë¬¼í’ˆì˜ ê°€ê²©ì„ í¬í•¨í•´ì„œ ì‘ì„±í•´ì¤˜. ë¶€ìŠ¤ì— ëŒ€í•œ ì§§ì€ ì„¤ëª…ê³¼ ë‹´ë‹¹í•  ì„ ìƒë‹˜ ì´ë¦„ë„ í•¨ê»˜ í¬í•¨í•´ì¤˜.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "boothName": { "type": "STRING" },
                            "teacherName": { "type": "STRING" },
                            "boothDescription": { "type": "STRING" },
                            "items": { 
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "name": { "type": "STRING" },
                                        "price": { "type": "NUMBER" }
                                    },
                                    "propertyOrdering": ["name", "price"]
                                }
                            }
                        },
                        "propertyOrdering": ["boothName", "teacherName", "boothDescription", "items"]
                    }
                }
            };
            
            try {
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const content = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (content) {
                    const parsedData = JSON.parse(content);
                    boothNameInput.value = parsedData.boothName || '';
                    teacherNameInput.value = parsedData.teacherName || '';
                    boothDescriptionTextarea.value = parsedData.boothDescription || '';
                    currentItems = parsedData.items || [];
                    renderItemsList();
                } else {
                    throw new Error("API ì‘ë‹µì— ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ì˜¤ë¥˜</h3>
                        <p class="text-gray-600">ì•„ì´ë””ì–´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                        <div class="flex justify-end mt-4">
                            <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none close-modal">í™•ì¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            } finally {
                generateIdeaBtn.disabled = false;
                loadingMessage.classList.add('hidden');
            }
        };

        // ì¿ íŒ¡ ê²€ìƒ‰ ê¸°ëŠ¥ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        coupangSearchBtn.addEventListener('click', () => {
            const searchTerm = coupangSearchInput.value;
            if (searchTerm.trim() !== '') {
                const encodedTerm = encodeURIComponent(searchTerm);
                const coupangUrl = `https://www.coupang.com/np/search?q=${encodedTerm}`;
                window.open(coupangUrl, '_blank');
            } else {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50";
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">ì•Œë¦¼</h3>
                        <p class="text-gray-600">ê²€ìƒ‰í•  ë¬¼í’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <div class="flex justify-end mt-4">
                            <button class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 focus:outline-none close-modal">í™•ì¸</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        generateIdeaBtn.addEventListener('click', generateGeminiIdea);
        
        // ì›¹ì•± ì‹œì‘
        initializeFirebase();
    </script>
</body>
</html>
